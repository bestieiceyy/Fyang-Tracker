<!DOCTYPE html>
<html>
<head>
  <title>Live Vote Tracker</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin-top: 40px; background: #fafafa; }
    .box { font-size: 28px; padding: 25px; border-radius: 12px; background: #fff; display: inline-block; box-shadow: 0 0 12px rgba(0,0,0,0.1); }
    .title { font-size: 36px; margin-bottom: 20px; font-weight: bold; }
    .candidate { margin: 15px 0; }
    .gap-green { color: green; font-weight: bold; font-size: 30px; }
    .gap-red { color: red; font-weight: bold; font-size: 30px; }
    .added { font-size: 20px; color: #555; }
    .clock { margin-top: 20px; font-size: 22px; color: #333; }
    .log { margin-top: 25px; padding: 15px; width: 400px; max-width: 90%; margin-left: auto; margin-right: auto; background: #fff; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); text-align: left; font-size: 16px; }
    .log-entry { margin-bottom: 8px; }
  </style>
</head>
<body>
  <div class="box">
    <div class="title">Live Vote Counter</div>
    <div class="candidate" id="fyang"></div>
    <div class="candidate" id="will"></div>
    <div class="candidate" id="gap"></div>
    <div class="clock" id="clock"></div>
  </div>

  <div class="log" id="log">
    <b>Last 5 Updates:</b>
  </div>

  <script>
    const POLL_URL = "https://polls.polldaddy.com/vote-js.php?p=15909793";
    let prevFyang = null, prevWill = null, prevDiff = null;

    // Clock updater (every second)
    function updateClock() {
      let now = new Date().toLocaleString("en-PH", { timeZone: "Asia/Manila" });
      document.getElementById("clock").innerText = "⏱ " + now;
    }
    setInterval(updateClock, 1000);
    updateClock();

    // Function to log updates (keep only last 5)
    function logUpdate(text) {
      let logBox = document.getElementById("log");
      let entry = document.createElement("div");
      entry.className = "log-entry";
      entry.innerText = text;
      logBox.appendChild(entry);

      // remove old entries if more than 5
      while (logBox.getElementsByClassName("log-entry").length > 5) {
        logBox.removeChild(logBox.getElementsByClassName("log-entry")[0]);
      }
    }

    // Voting fetcher
    async function fetchVotes() {
      try {
        let response = await fetch(POLL_URL);
        let text = await response.text();

        let matches = [...text.matchAll(/class="pds-answer-text"[^>]*>(.*?)<\/span>.*?\(([\d,]+)\s+votes\)/gs)];

        let fyang = null, will = null;
        for (let m of matches) {
          let name = m[1].trim().toUpperCase();
          let votes = parseInt(m[2].replace(/,/g, ''));
          if (name.includes("FYANG")) fyang = votes;
          if (name.includes("WILL ASHLEY")) will = votes;
        }

        if (fyang !== null && will !== null) {
          let fyangAdded = prevFyang !== null ? fyang - prevFyang : 0;
          let willAdded = prevWill !== null ? will - prevWill : 0;

          document.getElementById("fyang").innerHTML =
            `Fyang : ${fyang.toLocaleString()} <span class="added">(+${
              fyangAdded.toLocaleString()
            })</span>`;

          document.getElementById("will").innerHTML =
            `Will : ${will.toLocaleString()} <span class="added">(+${
              willAdded.toLocaleString()
            })</span>`;

          let diff = fyang - will;
          let diffAdded = prevDiff !== null ? diff - prevDiff : 0;
          let gapElem = document.getElementById("gap");

          if (diff > 0) {
            gapElem.className = "gap-green";
            gapElem.innerHTML = `Gap: ${diff.toLocaleString()} <span class="added">(${
              diffAdded >= 0 ? "+" : ""
            }${diffAdded.toLocaleString()})</span> Fyang leading`;
          } else if (diff < 0) {
            gapElem.className = "gap-red";
            gapElem.innerHTML = `Gap: ${Math.abs(diff).toLocaleString()} <span class="added">(${
              diffAdded >= 0 ? "+" : ""
            }${diffAdded.toLocaleString()})</span> Will leading`;
          } else {
            gapElem.className = "";
            gapElem.innerText = `Gap: 0 (Tied)`;
          }

          // log update
          let now = new Date().toLocaleTimeString("en-PH", { timeZone: "Asia/Manila" });
          logUpdate(`${now} → Fyang: ${fyang.toLocaleString()}, Will: ${will.toLocaleString()}, Gap: ${diff.toLocaleString()}`);

          prevFyang = fyang;
          prevWill = will;
          prevDiff = diff;
        } else {
          document.getElementById("gap").innerText = "⚠️ Candidates not found";
        }
      } catch (err) {
        document.getElementById("gap").innerText = "⚠️ Fetch failed";
      }
    }

    // Align updates exactly on 10s intervals
    function scheduleFetch() {
      let now = new Date();
      let delay = 10000 - (now.getSeconds() * 1000 + now.getMilliseconds()) % 10000;
      setTimeout(() => {
        fetchVotes();
        setInterval(fetchVotes, 10000);
      }, delay);
    }

    scheduleFetch();
  </script>
</body>
</html>
